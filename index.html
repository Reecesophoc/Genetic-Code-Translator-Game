<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Genetic Code Translator Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const QUALTRICS_URL = "https://sydney.au1.qualtrics.com/jfe/form/SV_9QxHNKnV1XcqJz8";
    const TUTORIAL_OPT_OUT_KEY = "gctg_tutorial_optout";

    function shouldShowFeedback(prevCount, threshold = 2) {
      const next = prevCount + 1;
      return next === threshold;
    }

    const CODON_TABLE = {
      UUU: { aa: "F", name: "Phenylalanine" }, UUC: { aa: "F", name: "Phenylalanine" },
      UUA: { aa: "L", name: "Leucine" },      UUG: { aa: "L", name: "Leucine" },
      CUU: { aa: "L", name: "Leucine" },      CUC: { aa: "L", name: "Leucine" },
      CUA: { aa: "L", name: "Leucine" },      CUG: { aa: "L", name: "Leucine" },
      AUU: { aa: "I", name: "Isoleucine" },   AUC: { aa: "I", name: "Isoleucine" }, AUA: { aa: "I", name: "Isoleucine" },
      AUG: { aa: "M", name: "Methionine", isStart: true },
      GUU: { aa: "V", name: "Valine" },       GUC: { aa: "V", name: "Valine" },     GUA: { aa: "V", name: "Valine" },     GUG: { aa: "V", name: "Valine" },
      UCU: { aa: "S", name: "Serine" },       UCC: { aa: "S", name: "Serine" },     UCA: { aa: "S", name: "Serine" },     UCG: { aa: "S", name: "Serine" },
      AGU: { aa: "S", name: "Serine" },       AGC: { aa: "S", name: "Serine" },
      CCU: { aa: "P", name: "Proline" },      CCC: { aa: "P", name: "Proline" },    CCA: { aa: "P", name: "Proline" },    CCG: { aa: "P", name: "Proline" },
      ACU: { aa: "T", name: "Threonine" },    ACC: { aa: "T", name: "Threonine" },   ACA: { aa: "T", name: "Threonine" },   ACG: { aa: "T", name: "Threonine" },
      GCU: { aa: "A", name: "Alanine" },      GCC: { aa: "A", name: "Alanine" },    GCA: { aa: "A", name: "Alanine" },    GCG: { aa: "A", name: "Alanine" },
      UAU: { aa: "Y", name: "Tyrosine" },     UAC: { aa: "Y", name: "Tyrosine" },
      CAU: { aa: "H", name: "Histidine" },    CAC: { aa: "H", name: "Histidine" },
      CAA: { aa: "Q", name: "Glutamine" },    CAG: { aa: "Q", name: "Glutamine" },
      AAU: { aa: "N", name: "Asparagine" },   AAC: { aa: "N", name: "Asparagine" },
      AAA: { aa: "K", name: "Lysine" },       AAG: { aa: "K", name: "Lysine" },
      GAU: { aa: "D", name: "Aspartate" },    GAC: { aa: "D", name: "Aspartate" },
      GAA: { aa: "E", name: "Glutamate" },    GAG: { aa: "E", name: "Glutamate" },
      UGU: { aa: "C", name: "Cysteine" },     UGC: { aa: "C", name: "Cysteine" },
      UGG: { aa: "W", name: "Tryptophan" },
      CGU: { aa: "R", name: "Arginine" },     CGC: { aa: "R", name: "Arginine" },    CGA: { aa: "R", name: "Arginine" },    CGG: { aa: "R", name: "Arginine" },
      AGA: { aa: "R", name: "Arginine" },     AGG: { aa: "R", name: "Arginine" },
      GGU: { aa: "G", name: "Glycine" },      GGC: { aa: "G", name: "Glycine" },     GGA: { aa: "G", name: "Glycine" },     GGG: { aa: "G", name: "Glycine" },
      UAA: { aa: "*", name: "Stop", isStop: true }, UAG: { aa: "*", name: "Stop", isStop: true }, UGA: { aa: "*", name: "Stop", isStop: true },
    };

    const AMINO_ACIDS = new Set(["A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V"]);
    const BASES = ["A","U","C","G"];
    const choice = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const codonsForAA = (aa) => Object.entries(CODON_TABLE).filter(([_, v]) => v.aa === aa && !v.isStop).map(([k]) => k);
    const randomCodonForAA = (aa) => choice(codonsForAA(aa));

    const randomPeptide = (length) => {
      const letters = ["M"]; const alphabet = Array.from(AMINO_ACIDS).filter((x) => x !== "M");
      while (letters.length < length) letters.push(choice(alphabet));
      return letters.join("");
    };

    function buildmRNA({ peptideLength }) {
      const utr5Len = Math.floor(Math.random() * 9) + 3;
      const utr3Len = Math.floor(Math.random() * 9) + 3;
      const utr5 = Array.from({ length: utr5Len }, () => choice(BASES)).join("");
      const utr3 = Array.from({ length: utr3Len }, () => choice(BASES)).join("");
      const peptide = randomPeptide(peptideLength);
      const coding = ["AUG", ...peptide.slice(1).split("").map(randomCodonForAA), choice(["UAA","UAG","UGA"])].join("");
      return { mrna: utr5 + coding + utr3, utr5Len, utr3Len, peptide, coding };
    }

    function translateFrom(mrna, startIndex) {
      const codons = []; const aas = [];
      for (let i = startIndex; i + 2 < mrna.length; i += 3) {
        const codon = mrna.slice(i, i + 3);
        const info = CODON_TABLE[codon];
        if (!info) break;
        codons.push(codon);
        if (info.isStop) break; else aas.push(info.aa);
      }
      return { codons, aas: aas.join("") };
    }

    function FeedbackModal({ show, onClose, url = QUALTRICS_URL }) {
      useEffect(() => {
        if (!show) return; const onKey = (e) => { if (e.key === "Escape") onClose(); };
        window.addEventListener("keydown", onKey); return () => window.removeEventListener("keydown", onKey);
      }, [show, onClose]);
      if (!show) return null; return (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50" onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="fb-title">
          <div className="max-w-md w-full bg-white rounded-2xl border shadow-lg p-6" onClick={(e) => e.stopPropagation()}>
            <h3 id="fb-title" className="text-lg font-medium mb-2">Reece really appreciates any feedback you have</h3>
            <p className="text-sm text-slate-700 mb-4">You can leave feedback in as little as 10 seconds. It genuinely helps improve this activity for future students.</p>
            <div className="flex gap-3">
              <a href={url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 rounded-xl border bg-emerald-600 text-white hover:bg-emerald-500 shadow-sm">Leave feedback now</a>
              <button onClick={onClose} className="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm">I’ll leave feedback later</button>
            </div>
          </div>
        </div>
      );
    }

    function TutorialModal({ show, onClose, onOptOut }) {
      const [step, setStep] = useState(0);
      const steps = [
        { title: "Welcome", body: (<><p className="mb-2">This quick tour will show you how to use the Genetic Code Translator. It takes ~30 seconds.</p><p className="text-slate-600 text-sm">You can opt out any time with “I don’t need help”.</p></>) },
        { title: "Set up the question", body: (<><p className="mb-2">Choose <span className="font-medium">Difficulty</span> and adjust the <span className="font-medium">Peptide length</span>.</p><p className="text-slate-600 text-sm">Beginner highlights the true start codon (AUG) and shows the reading frame. Advanced gives no hints.</p></>) },
        { title: "Read the mRNA", body: (<><p className="mb-2">Scan the mRNA string (5′→3′). In Beginner mode the start AUG is highlighted.</p><p className="text-slate-600 text-sm">Use the <span className="font-medium">Codon helper</span> for quick lookups.</p></>) },
        { title: "Enter your protein", body: (<><p className="mb-2">Type the one-letter amino acid codes (no stop). Start with <span className="font-mono">M</span> for AUG.</p><p className="text-slate-600 text-sm">Then press <span className="font-medium">Submit</span> to check.</p></>) },
        { title: "Check feedback", body: (<><p className="mb-2">After submitting, see per-codon feedback. Cells stay blank until you enter a guess.</p><p className="text-slate-600 text-sm">Use <span className="font-medium">Show answer</span> for the model answer or click <span className="font-medium">New sequence</span> for another round.</p></>) },
      ];
      useEffect(() => { if (!show) setStep(0); }, [show]);
      useEffect(() => {
        if (!show) return; const onKey = (e) => { if (e.key === "Escape") onClose(); };
        window.addEventListener("keydown", onKey); return () => window.removeEventListener("keydown", onKey);
      }, [show, onClose]);
      if (!show) return null; const s = steps[step];
      return (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50" onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="tut-title">
          <div className="max-w-lg w-full bg-white rounded-2xl border shadow-lg p-6" onClick={(e) => e.stopPropagation()}>
            <h3 id="tut-title" className="text-lg font-medium mb-2">{s.title}</h3>
            <div className="text-sm text-slate-700 mb-4">{s.body}</div>
            <div className="flex flex-wrap gap-2 justify-between">
              <div className="flex gap-2">
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={onClose}>Close</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={onOptOut}>I don’t need help</button>
              </div>
              <div className="flex gap-2">
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setStep((n) => Math.max(0, n - 1))} disabled={step===0}>Back</button>
                <button className="px-3 py-2 rounded-xl border bg-emerald-600 text-white hover:bg-emerald-500 shadow-sm" onClick={() => step < steps.length - 1 ? setStep(step + 1) : onClose()}>{step < steps.length - 1 ? "Next" : "Finish"}</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function GeneticCodeTranslatorGame() {
      const [difficulty, setDifficulty] = useState("Beginner");
      const [lengthAA, setLengthAA] = useState(6);

      const [mrna, setMrna] = useState("");
      const [utr5Len, setUtr5Len] = useState(0);
      const [startIndex, setStartIndex] = useState(0);

      const [userAA, setUserAA] = useState("");
      const [submitted, setSubmitted] = useState(false);
      const [showAnswer, setShowAnswer] = useState(false);
      const [showCodonHelp, setShowCodonHelp] = useState(false);

      const [submitCount, setSubmitCount] = useState(0);
      const [showFeedback, setShowFeedback] = useState(false);

      const [showTutorial, setShowTutorial] = useState(false);

      useEffect(() => {
        try {
          const optedOut = localStorage.getItem(TUTORIAL_OPT_OUT_KEY) === "1";
          if (!optedOut) setShowTutorial(true);
        } catch (_) {}
      }, []);

      const newRound = () => {
        const built = buildmRNA({ peptideLength: lengthAA });
        setMrna(built.mrna);
        setUtr5Len(built.utr5Len);
        setStartIndex(built.utr5Len);
        setUserAA("");
        setSubmitted(false);
        setShowAnswer(false);
      };

      useEffect(() => { newRound(); }, []);
      useEffect(() => { newRound(); }, [difficulty, lengthAA]);

      const translation = useMemo(() => translateFrom(mrna, startIndex), [mrna, startIndex]);
      const expected = translation.aas;

      const scorePct = useMemo(() => {
        let correct = 0;
        for (let i = 0; i < expected.length; i++) if ((userAA[i] || "").toUpperCase() === expected[i]) correct++;
        return expected.length ? Math.round((correct / expected.length) * 100) : 0;
      }, [expected, userAA]);

      const renderMrna = useMemo(() => {
        const elems = [];
        let i = 0;
        while (i < mrna.length) {
          if (difficulty === "Beginner" && i === utr5Len && mrna.slice(i, i + 3) === "AUG") {
            elems.push(
              <span key={"aug-"+i} className="inline-flex items-center justify-center font-mono text-sm md:text-base px-1.5 py-0.5 mx-[1px] rounded-md border bg-emerald-50 border-emerald-300" title="Start codon (AUG)">AUG</span>
            );
            i += 3; continue;
          }
          elems.push(<span key={"b-"+i} className="font-mono text-sm md:text-base px-[2px]">{mrna[i]}</span>);
          i += 1;
        }
        return elems;
      }, [mrna, utr5Len, difficulty]);

      const handleAAInput = (val) => {
        const cleaned = val.toUpperCase().replace(/[^ARNDCEQGHILKMFPSTWYV]/g, "").slice(0, expected.length);
        setUserAA(cleaned);
        setSubmitted(false);
      };

      const handleSubmit = () => {
        setSubmitted(true);
        setSubmitCount((prev) => {
          const next = prev + 1;
          if (shouldShowFeedback(prev, 2)) setShowFeedback(true);
          return next;
        });
      };

      return (
        <div className="min-h-screen w-full bg-slate-50 text-slate-800 p-6">
          <div className="max-w-5xl mx-auto space-y-6">
            <header className="flex items-start justify-between">
              <div>
                <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Genetic Code Translator</h1>
                <p className="text-slate-600 mt-1">Translate the mRNA (5′→3′) into a polypeptide. Type one-letter amino-acid codes (no stop). Start codon is AUG.</p>
              </div>
              <div className="hidden md:flex gap-2">
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => navigator.clipboard?.writeText(mrna)} title="Copy mRNA to clipboard">Copy mRNA</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setShowCodonHelp(true)} title="Open codon helper">Codon helper</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setShowTutorial(true)} title="Quick tutorial">Help</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setShowFeedback(true)} title="Leave feedback about this game">Leave feedback</button>
              </div>
            </header>

            <section className="grid md:grid-cols-3 gap-4">
              <div className="p-4 rounded-2xl bg-white border shadow-sm">
                <h2 className="font-medium mb-3">Difficulty</h2>
                <div className="flex gap-2">
                  {[["Beginner"],["Advanced"]].map(([d]) => (
                    <button key={d} onClick={() => setDifficulty(d)} className={["px-3 py-1.5 rounded-xl border text-sm", difficulty === d ? "bg-slate-900 text-white border-slate-900" : "bg-white hover:bg-slate-50"].join(" ")}>{d}</button>
                  ))}
                </div>
                <p className="text-xs text-slate-500 mt-2">Beginner: start codon highlighted with frame. Advanced: no hints.</p>
              </div>

              <div className="p-4 rounded-2xl bg-white border shadow-sm">
                <h2 className="font-medium mb-3">Peptide length</h2>
                <input type="range" min={3} max={12} value={lengthAA} onChange={(e) => setLengthAA(parseInt(e.target.value))} className="w-full" />
                <div className="text-sm mt-1">{lengthAA} amino acids (includes start M; excludes stop)</div>
              </div>

              <div className="p-4 rounded-2xl bg-white border shadow-sm">
                <h2 className="font-medium mb-3">Actions</h2>
                <div className="flex gap-2 flex-wrap">
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={newRound}>New sequence</button>
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setShowCodonHelp(true)}>Codon helper</button>
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setShowTutorial(true)}>Help</button>
                </div>
              </div>
            </section>

            <section className="p-4 rounded-2xl bg-white border shadow-sm">
              <div className="flex items-center justify-between mb-2">
                <h2 className="font-medium">mRNA (5′ → 3′)</h2>
                <div className="text-xs text-slate-500">{difficulty === "Beginner" ? "Start codon highlighted." : "No hints shown."}</div>
              </div>
              <div className="flex flex-wrap items-center leading-7">{renderMrna}</div>
            </section>

            {difficulty === "Beginner" && (
              <section className="p-4 rounded-2xl bg-white border shadow-sm">
                <h3 className="font-medium mb-2">Reading frame (from start to first stop)</h3>
                <div className="flex flex-wrap items-center">
                  {translation.codons.map((codon, i) => (
                    <span key={"rf-"+i} className={["inline-flex items-center justify-center rounded-md px-2 py-1 mx-0.5 border text-sm font-mono select-none", CODON_TABLE[codon]?.isStop ? "bg-rose-50 border-rose-300" : "border-slate-300"].join(" ")} title={CODON_TABLE[codon]?.isStop ? `${codon} – Stop` : `${codon} → ${CODON_TABLE[codon]?.aa} ${CODON_TABLE[codon]?.name}`}>{codon}</span>
                  ))}
                </div>
              </section>
            )}

            <section className="p-4 rounded-2xl bg-white border shadow-sm space-y-4">
              <div className="flex items-center gap-3 flex-wrap">
                <label className="text-sm font-medium">Your protein (1-letter):</label>
                <input
                  value={userAA}
                  onChange={(e) => handleAAInput(e.target.value)}
                  placeholder={"e.g., MHFST…"}
                  className="flex-1 min-w-[240px] px-3 py-2 rounded-xl border bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500"
                />
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => { setUserAA(""); setSubmitted(false); }}>Clear</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={handleSubmit} disabled={userAA.length === 0}>Submit</button>
              </div>

              {submitted && (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="col-span-2">
                    <h3 className="font-medium mb-2">Per-codon feedback</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm border">
                        <thead className="bg-slate-100">
                          <tr>
                            <th className="px-2 py-1 border">#</th>
                            <th className="px-2 py-1 border">Codon</th>
                            <th className="px-2 py-1 border">Your AA</th>
                            <th className="px-2 py-1 border">Correct AA</th>
                            <th className="px-2 py-1 border">Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          {translation.codons.map((codon, i) => {
                            const info = CODON_TABLE[codon];
                            const correctAA = info?.isStop ? "*" : info?.aa || "?";
                            const u = (userAA[i] || "").toUpperCase();
                            const hasGuess = u.length > 0;
                            const ok = hasGuess && !info?.isStop && u === correctAA;
                            return (
                              <tr key={i} className={ok ? "bg-emerald-50" : hasGuess ? "bg-rose-50" : ""}>
                                <td className="px-2 py-1 border text-center">{i + 1}</td>
                                <td className="px-2 py-1 border font-mono text-center">{hasGuess ? codon : ""}</td>
                                <td className="px-2 py-1 border text-center">{u}</td>
                                <td className="px-2 py-1 border text-center">{hasGuess ? (info?.isStop ? "Stop" : correctAA) : ""}</td>
                                <td className="px-2 py-1 border text-center">{hasGuess ? (info?.isStop ? "Stop" : ok ? "✓" : "✗") : ""}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div>
                    <h3 className="font-medium mb-2">Summary</h3>
                    <div className="p-3 rounded-xl border bg-slate-50">
                      <div className="text-3xl font-semibold">{scorePct}%</div>
                      <div className="text-sm text-slate-600 mt-1">accuracy across {expected.length} codons</div>
                    </div>

                    <div className="mt-3 flex gap-2">
                      <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setShowAnswer((s) => !s)}>{showAnswer ? "Hide answer" : "Show answer"}</button>
                      <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={() => setShowFeedback(true)}>Leave feedback</button>
                    </div>

                    <p className="text-sm text-slate-700 mt-3">{(() => { const pct = scorePct; return pct === 100 ? "Spot on! Perfect translation. You’ve nailed start→stop and all codons." : pct >= 80 ? "Great work! Very minor slips—your frame and codons are largely correct." : pct >= 60 ? "Good progress—most codons are correct. Check the frame or a tricky codon or two." : pct >= 40 ? "You’re on the right track. Re-scan for AUG and watch for near-lookalike codons." : "Tough round. Try scanning to the first AUG and re-check each triplet carefully."; })()} You can retry the quiz to get different questions.</p>

                    {showAnswer && (
                      <div className="mt-3 text-xs text-slate-600">
                        <div><span className="font-medium">Correct translation:</span> {expected}</div>
                        <div className="mt-1"><span className="font-medium">Codons:</span> {translation.codons.join("-")}</div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </section>
          </div>

          {showCodonHelp && (
            <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-40" onClick={() => setShowCodonHelp(false)}>
              <div className="max-w-4xl w-full bg-white rounded-2xl border shadow-lg p-4" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-medium">Codon helper</h3>
                  <button className="px-2 py-1 rounded-lg border" onClick={() => setShowCodonHelp(false)}>Close</button>
                </div>
                <p className="text-sm text-slate-600 mb-3">Click a codon to copy. Stop codons shown as *; AUG = start.</p>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                  {Object.entries(CODON_TABLE).sort((a, b) => a[0].localeCompare(b[0])).map(([codon, info]) => (
                    <button
                      key={codon}
                      onClick={() => navigator.clipboard && navigator.clipboard.writeText(codon)}
                      className={["flex items-center justify-between w-full px-3 py-2 border rounded-xl", info.isStop ? "bg-rose-50 border-rose-200" : info.isStart ? "bg-emerald-50 border-emerald-200" : "bg-white"].join(" ")}
                      title={`${codon} → ${info.isStop ? "Stop" : info.aa} ${info.name}`}
                    >
                      <span className="font-mono">{codon}</span>
                      <span className="text-sm">{info.isStop ? "Stop" : `${info.aa} – ${info.name}`}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          <TutorialModal
            show={showTutorial}
            onClose={() => setShowTutorial(false)}
            onOptOut={() => { try { localStorage.setItem(TUTORIAL_OPT_OUT_KEY, "1"); } catch(_) {}; setShowTutorial(false); }}
          />

          <FeedbackModal show={showFeedback} onClose={() => setShowFeedback(false)} url={QUALTRICS_URL} />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<GeneticCodeTranslatorGame />);
  </script>
</body>
</html>
