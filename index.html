<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Genetic Code Translator Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 17 UMD for sandbox/browser compatibility -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React; // React 17

    const QUALTRICS_URL = "https://sydney.au1.qualtrics.com/jfe/form/SV_9QxHNKnV1XcqJz8";
    const TUTORIAL_OPT_OUT_KEY = "gctg_tutorial_optout";

    // ---------- Genetic code and helpers ----------
    const CODON_TABLE = {
      UUU:{aa:"F",name:"Phenylalanine"},UUC:{aa:"F",name:"Phenylalanine"},UUA:{aa:"L",name:"Leucine"},UUG:{aa:"L",name:"Leucine"},
      CUU:{aa:"L",name:"Leucine"},CUC:{aa:"L",name:"Leucine"},CUA:{aa:"L",name:"Leucine"},CUG:{aa:"L",name:"Leucine"},
      AUU:{aa:"I",name:"Isoleucine"},AUC:{aa:"I",name:"Isoleucine"},AUA:{aa:"I",name:"Isoleucine"},AUG:{aa:"M",name:"Methionine",isStart:true},
      GUU:{aa:"V",name:"Valine"},GUC:{aa:"V",name:"Valine"},GUA:{aa:"V",name:"Valine"},GUG:{aa:"V",name:"Valine"},
      UCU:{aa:"S",name:"Serine"},UCC:{aa:"S",name:"Serine"},UCA:{aa:"S",name:"Serine"},UCG:{aa:"S",name:"Serine"},AGU:{aa:"S",name:"Serine"},AGC:{aa:"S",name:"Serine"},
      CCU:{aa:"P",name:"Proline"},CCC:{aa:"P",name:"Proline"},CCA:{aa:"P",name:"Proline"},CCG:{aa:"P",name:"Proline"},
      ACU:{aa:"T",name:"Threonine"},ACC:{aa:"T",name:"Threonine"},ACA:{aa:"T",name:"Threonine"},ACG:{aa:"T",name:"Threonine"},
      GCU:{aa:"A",name:"Alanine"},GCC:{aa:"A",name:"Alanine"},GCA:{aa:"A",name:"Alanine"},GCG:{aa:"A",name:"Alanine"},
      UAU:{aa:"Y",name:"Tyrosine"},UAC:{aa:"Y",name:"Tyrosine"},
      CAU:{aa:"H",name:"Histidine"},CAC:{aa:"H",name:"Histidine"},CAA:{aa:"Q",name:"Glutamine"},CAG:{aa:"Q",name:"Glutamine"},
      AAU:{aa:"N",name:"Asparagine"},AAC:{aa:"N",name:"Asparagine"},AAA:{aa:"K",name:"Lysine"},AAG:{aa:"K",name:"Lysine"},
      GAU:{aa:"D",name:"Aspartate"},GAC:{aa:"D",name:"Aspartate"},GAA:{aa:"E",name:"Glutamate"},GAG:{aa:"E",name:"Glutamate"},
      UGU:{aa:"C",name:"Cysteine"},UGC:{aa:"C",name:"Cysteine"},UGG:{aa:"W",name:"Tryptophan"},
      CGU:{aa:"R",name:"Arginine"},CGC:{aa:"R",name:"Arginine"},CGA:{aa:"R",name:"Arginine"},CGG:{aa:"R",name:"Arginine"},AGA:{aa:"R",name:"Arginine"},AGG:{aa:"R",name:"Arginine"},
      GGU:{aa:"G",name:"Glycine"},GGC:{aa:"G",name:"Glycine"},GGA:{aa:"G",name:"Glycine"},GGG:{aa:"G",name:"Glycine"},
      UAA:{aa:"*",name:"Stop",isStop:true},UAG:{aa:"*",name:"Stop",isStop:true},UGA:{aa:"*",name:"Stop",isStop:true},
    };
    const AMINO_ACIDS=new Set(["A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V"]);
    const BASES=["A","U","C","G"]; const pick=a=>a[Math.floor(Math.random()*a.length)];
    const codonsForAA=aa=>Object.entries(CODON_TABLE).filter(([,v])=>v.aa===aa&&!v.isStop).map(([k])=>k);
    const randomCodonForAA=aa=>pick(codonsForAA(aa));

    // 3-letter ↔ 1-letter maps
    const AA3_TO_1 = { ALA:"A", ARG:"R", ASN:"N", ASP:"D", CYS:"C", GLN:"Q", GLU:"E", GLY:"G", HIS:"H", ILE:"I", LEU:"L", LYS:"K", MET:"M", PHE:"F", PRO:"P", SER:"S", THR:"T", TRP:"W", TYR:"Y", VAL:"V", TER:"*", STOP:"*" };
    const AA1_TO_3 = { A:"Ala", R:"Arg", N:"Asn", D:"Asp", C:"Cys", Q:"Gln", E:"Glu", G:"Gly", H:"His", I:"Ile", L:"Leu", K:"Lys", M:"Met", F:"Phe", P:"Pro", S:"Ser", T:"Thr", W:"Trp", Y:"Tyr", V:"Val", "*":"Stop" };

    const randomPeptide=len=>{const letters=["M"];const alphabet=[...AMINO_ACIDS].filter(x=>x!=="M");while(letters.length<len)letters.push(pick(alphabet));return letters.join("");};
    function buildmRNA({peptideLength}){
      const utr5Len=Math.floor(Math.random()*9)+3;const utr3Len=Math.floor(Math.random()*9)+3;
      const utr5=Array.from({length:utr5Len},()=>pick(BASES)).join("");
      const utr3=Array.from({length:utr3Len},()=>pick(BASES)).join("");
      const peptide=randomPeptide(peptideLength);
      const coding=["AUG",...peptide.slice(1).split("").map(randomCodonForAA),pick(["UAA","UAG","UGA"])].join("");
      return{mrna:utr5+coding+utr3,utr5Len,utr3Len,peptide,coding}
    };

    // Translation from an index (no highlight assumptions)
    function translateFrom(mrna,startIndex){
      if(!Number.isFinite(startIndex) || startIndex<0) return {codons:[], aas:""};
      const codons=[];const aas=[];
      for(let i=startIndex;i+2<mrna.length;i+=3){
        const codon=mrna.slice(i,i+3);
        const info=CODON_TABLE[codon];
        if(!info) break;
        codons.push(codon);
        if(info.isStop) break; else aas.push(info.aa);
      }
      return{codons,aas:aas.join("")}
    };

    // ---------- Utilities ----------
    const isBoundary = (pos, startIndex) => ((pos - startIndex) % 3 === 0);

    // ---------- Feedback modal ----------
    function FeedbackModal({ show, onClose, url = QUALTRICS_URL }){
      useEffect(()=>{if(!show)return;const onKey=e=>{if(e.key==="Escape")onClose()};window.addEventListener("keydown",onKey);return()=>window.removeEventListener("keydown",onKey)},[show,onClose]);
      if(!show) return null;
      return (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="max-w-md w-full bg-white rounded-2xl border shadow-lg p-6" onClick={e=>e.stopPropagation()}>
            <h3 className="text-lg font-medium mb-2">Reece really appreciates any feedback you have</h3>
            <p className="text-sm text-slate-700 mb-4">You can leave feedback in as little as 10 seconds. It genuinely helps improve this activity for future students.</p>
            <div className="flex gap-3">
              <a href={url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 rounded-xl border bg-emerald-600 text-white hover:bg-emerald-500 shadow-sm">Leave feedback now</a>
              <button onClick={onClose} className="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm">I’ll leave feedback later</button>
            </div>
          </div>
        </div>
      );
    }

    // ---------- Tutorial modal ----------
    function TutorialModal({ show, onClose, onOptOut }){
      const [step,setStep]=useState(0);
      const steps=[
        {t:"Welcome",b:(<>This quick tour takes ~30 seconds. You can opt out any time with “I don’t need help”.</>)},
        {t:"Set up the question",b:(<>Choose <b>Difficulty</b> and adjust <b>Peptide length</b>. Beginner highlights AUG; Advanced gives no hints.</>)},
        {t:"Read the mRNA",b:(<>Scan the mRNA string (5′→3′). Use the <b>Codon helper</b> for quick look‑ups.</>)},
        {t:"Enter your protein",b:(<>Type one‑letter or switch to <b>3‑letter</b> amino‑acid codes (no stop). Start with <span className="font-mono">M</span>. Then press <b>Submit</b>.</>)},
        {t:"Track your place",b:(<>Use the <b>Codon tracker</b> to tick off codons you’ve handled. In Advanced, click any base in the mRNA to set your starting position; in Beginner it uses the start AUG.</>)},
        {t:"Check feedback",b:(<>After submitting, see per‑codon feedback. Blank cells mean no guess yet. Use <b>Show answer</b> or <b>New sequence</b>.</>)},
      ];
      useEffect(()=>{if(!show) setStep(0)},[show]);
      if(!show) return null; const s=steps[step];
      return (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="max-w-lg w-full bg-white rounded-2xl border shadow-lg p-6" onClick={e=>e.stopPropagation()}>
            <h3 className="text-lg font-medium mb-2">{s.t}</h3>
            <div className="text-sm text-slate-700 mb-4">{s.b}</div>
            <div className="flex justify-between items-center gap-2">
              <div className="flex gap-2">
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={onClose}>Close</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={onOptOut}>I don’t need help</button>
              </div>
              <div className="flex gap-2">
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setStep(s=>Math.max(0,s-1))} disabled={step===0}>Back</button>
                <button className="px-3 py-2 rounded-xl border bg-emerald-600 text-white hover:bg-emerald-500 shadow-sm" onClick={()=>step<steps.length-1?setStep(step+1):onClose()}>{step<steps.length-1?"Next":"Finish"}</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ---------- Mutation Helper (table) ----------
    function MutationHelperModal({ show, onClose }){
      if(!show) return null;
      const Row = ({dna, prot, desc, example, effect}) => (
        <tr>
          <td className="border px-2 py-1 align-top">{dna}</td>
          <td className="border px-2 py-1 align-top">{prot}</td>
          <td className="border px-2 py-1 align-top">{desc}</td>
          <td className="border px-2 py-1 align-top font-mono">{example}</td>
          <td className="border px-2 py-1 align-top">{effect}</td>
        </tr>
      );
      return (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="max-w-5xl w-full bg-white rounded-2xl border shadow-lg p-6" onClick={(e)=>e.stopPropagation()}>
            <div className="flex items-center justify-between mb-3"><h3 className="font-medium">Mutation helper</h3><button className="px-2 py-1 rounded-lg border" onClick={onClose}>Close</button></div>
            <p className="text-sm text-slate-600 mb-3">Reference for common DNA→protein mutation outcomes.</p>
            <div className="overflow-x-auto">
              <table className="w-full text-sm border bg-white">
                <thead className="bg-slate-100">
                  <tr>
                    <th className="border px-2 py-1 text-left">DNA Mutation</th>
                    <th className="border px-2 py-1 text-left">Protein Mutation</th>
                    <th className="border px-2 py-1 text-left">Description</th>
                    <th className="border px-2 py-1 text-left">Example (mRNA change)</th>
                    <th className="border px-2 py-1 text-left">Protein Effect</th>
                  </tr>
                </thead>
                <tbody>
                  <Row dna="Point mutation (SNP)" prot="Silent" desc="One base changes but amino acid stays the same" example="CUU → CUC" effect="Leucine → Leucine"/>
                  <Row dna="Point mutation (SNP)" prot="Missense" desc="One base change alters amino acid" example="CUU → AUU" effect="Leucine → Isoleucine"/>
                  <Row dna="Point mutation (SNP)" prot="Nonsense" desc="One base change creates a premature stop codon" example="UAU → UAA" effect="Tyrosine → STOP"/>
                  <Row dna="Insertion" prot="Frameshift or Unknown impact" desc="Addition of base(s) — frameshift unless change is a multiple of 3 **at a codon boundary**" example="CUU GGA → CUG UGG A…" effect="Frameshift by default; ×3 at codon boundary → frame preserved"/>
                  <Row dna="Deletion" prot="Frameshift or Unknown impact" desc="Removal of base(s) — frameshift unless change is a multiple of 3 **at a codon boundary**" example="CUU GGA → CUG A…" effect="Frameshift by default; ×3 at codon boundary → frame preserved"/>
                </tbody>
              </table>
            </div>
            <div className="mt-3 text-xs text-slate-700">
              <span className="font-medium">Note:</span> If a mutation disrupts the first <span className="font-mono">AUG</span> start codon, classify the protein effect as <span className="font-medium">Lost start codon</span>.
            </div>
          </div>
        </div>
      );
    }

    // ---------- Docked Codon Chart (optional on-page chart) ----------
    function DockedCodonChart({ show, onClose }){
      const [filterB1,setFilterB1]=useState("");
      const [filterB2,setFilterB2]=useState("");
      const [filterAA,setFilterAA]=useState("");
      const [labelMode,setLabelMode]=useState('1'); // 1 or 3
      if(!show) return null;
      return (
        <div className="fixed right-3 top-3 bottom-3 w-[min(420px,95vw)] z-40">
          <div className="h-full bg-white border rounded-2xl shadow-xl p-4 flex flex-col">
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-medium">Codon chart</h3>
              <div className="flex items-center gap-2">
                <div className="text-[11px] text-slate-600">Labels:</div>
                <div className="inline-flex border rounded-lg overflow-hidden text-[11px]">
                  <button className={`px-2 py-1 ${labelMode==='1'?'bg-slate-900 text-white':'bg-white'}`} onClick={()=>setLabelMode('1')}>1‑letter</button>
                  <button className={`px-2 py-1 ${labelMode==='3'?'bg-slate-900 text-white':'bg-white'}`} onClick={()=>setLabelMode('3')}>3‑letter</button>
                </div>
                <button className="px-2 py-1 rounded-lg border" onClick={onClose}>Close</button>
              </div>
            </div>
            <div className="grid grid-cols-3 gap-2 text-xs mb-3">
              <div>
                <div className="text-[11px] text-slate-600 mb-1">Base 1</div>
                <div className="flex gap-1 flex-wrap">
                  {["","A","U","C","G"].map(b=> (
                    <button key={'b1'+b} className={`px-2 py-1 border rounded-md ${filterB1===b?'bg-slate-900 text-white border-slate-900':'bg-white'}`} onClick={()=>setFilterB1(b)}>{b||'Any'}</button>
                  ))}
                </div>
              </div>
              <div>
                <div className="text-[11px] text-slate-600 mb-1">Base 2</div>
                <div className="flex gap-1 flex-wrap">
                  {["","A","U","C","G"].map(b=> (
                    <button key={'b2'+b} className={`px-2 py-1 border rounded-md ${filterB2===b?'bg-slate-900 text-white border-slate-900':'bg-white'}`} onClick={()=>setFilterB2(b)}>{b||'Any'}</button>
                  ))}
                </div>
              </div>
              <div>
                <div className="text-[11px] text-slate-600 mb-1">Amino acid</div>
                <input className="w-full px-2 py-1 border rounded-md" placeholder="e.g., M or Met" value={filterAA} onChange={e=>setFilterAA(e.target.value)} />
                <div className="text-[11px] text-slate-500 mt-1">Filter by 1‑letter (M) or 3‑letter (Met)</div>
              </div>
            </div>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 overflow-y-auto">
              {Object.entries(CODON_TABLE)
                .sort((a,b)=>a[0].localeCompare(b[0]))
                .filter(([codon, info])=>{
                  if(filterB1 && codon[0]!==filterB1) return false;
                  if(filterB2 && codon[1]!==filterB2) return false;
                  if(filterAA){
                    const q = filterAA.trim().toUpperCase();
                    const aa1 = info.isStop? '*' : info.aa;
                    const aa3 = info.isStop? 'STOP' : (AA1_TO_3[aa1]||'').toUpperCase();
                    if(!(aa1.includes(q) || aa3.includes(q))) return false;
                  }
                  return true;
                })
                .map(([codon,info])=> {
                  const aa1 = info.isStop ? '*' : info.aa;
                  const label = info.isStop ? 'Stop' : (labelMode==='1' ? aa1 : (AA1_TO_3[aa1]||aa1));
                  return (
                    <button key={'dock-'+codon} onClick={()=>navigator.clipboard&&navigator.clipboard.writeText(codon)} className={["flex items-center justify-between w-full px-2 py-1 border rounded-xl text-xs", info.isStop?"bg-rose-50 border-rose-200":info.isStart?"bg-emerald-50 border-emerald-200":"bg-white"].join(" ")} title={`${codon} → ${info.isStop?"Stop":info.aa} ${info.name}`}>
                      <span className="font-mono text-sm">{codon}</span>
                      <span className="ml-2">{label}</span>
                    </button>
                  );
                })}
            </div>
          </div>
        </div>
      );
    }

    // ---------- Mutation engine ----------
    const DNA_TYPES=["Point mutation (SNP)","Insertion","Deletion"];
    const PROTEIN_TYPES=["Silent","Missense","Nonsense","Frameshift","Unknown impact","Lost start codon"];

    function findStopIndex(mrna, startIndex){
      for(let i=startIndex;i+2<mrna.length;i+=3){ if(CODON_TABLE[mrna.slice(i,i+3)]?.isStop) return i; }
      return -1;
    }

    function classifyProteinEffect({op,k=1, oldAA, newAA, pos, startIndex, mutMrna}){
      if (mutMrna && mutMrna.slice(startIndex, startIndex+3) !== "AUG") return "Lost start codon";
      if(op==="Point mutation (SNP)"){
        if(newAA===oldAA) return "Silent";
        if(newAA.length < oldAA.length) return "Nonsense";
        return "Missense";
      }
      if(op==="Insertion" || op==="Deletion"){
        if((k % 3) !== 0) return "Frameshift";
        return isBoundary(pos,startIndex) ? "Unknown impact" : "Frameshift"; // ×3 mid‑codon still frameshifts
      }
      return "Frameshift";
    }

    function mutateRandom(mrna,startIndex){
      const stopIdx = findStopIndex(mrna,startIndex); if(stopIdx<0) return null;
      const dnaType = pick(["Point mutation (SNP)","Insertion","Deletion"]);
      const arr = mrna.split("");
      let k=1;
      let pos = startIndex + Math.floor(Math.random() * Math.max(1, (stopIdx - startIndex - 1)));
      pos = Math.max(startIndex, Math.min(pos, stopIdx-1));

      if(dnaType === "Point mutation (SNP)"){
        const options = BASES.filter(b=>b!==arr[pos]);
        arr[pos] = pick(options);
      } else if(dnaType === "Insertion"){
        k = (Math.random()<0.5?1:3);
        const ins = Array.from({length:k},()=>pick(BASES));
        arr.splice(pos,0,...ins);
      } else if(dnaType === "Deletion"){
        k = (Math.random()<0.5?1:3);
        if(pos + k > stopIdx) pos = Math.max(startIndex, stopIdx - k);
        arr.splice(pos,k);
      }

      const mutMrna = arr.join("");
      const oldAA = translateFrom(mrna,startIndex).aas;
      const newAA = translateFrom(mutMrna,startIndex).aas;
      const proteinType = classifyProteinEffect({op:dnaType, k, oldAA, newAA, pos, startIndex, mutMrna});
      return { mutMrna, dnaType, proteinType, k, oldAA, newAA, pos };
    }

    function diffSpans(a,b){
      const out=[]; const n=Math.max(a.length,b.length);
      for(let i=0;i<n;i++){
        const ca=a[i]||""; const cb=b[i]||""; const changed=ca!==cb;
        out.push(<span key={i} className={"font-mono px-[1px] "+(changed?"bg-yellow-200 rounded-sm":"")}>{cb||""}</span>);
      }
      return out;
    }

    // ---------- Codon Tracker ----------
    function CodonTracker({ mrna, startIndex, difficulty, manualStart, onResetManualStart }) {
      const [checked, setChecked] = useState(new Set());

      const effectiveStart = (difficulty === 'Beginner') ? startIndex : (typeof manualStart === 'number' ? manualStart : null);

      // Rebuild tracker when sequence/start changes and clear ticks
      useEffect(()=>{ setChecked(new Set()); }, [mrna, effectiveStart]);

      const codonChunks = useMemo(() => {
        if (effectiveStart == null) return [];
        const chunks = [];
        for (let i = effectiveStart; i < mrna.length; i += 3) {
          const end = Math.min(i + 3, mrna.length);
          const c = mrna.slice(i, end);
          const partial = (end - i) < 3;
          chunks.push({ i, c, partial });
          if (!partial && CODON_TABLE[c]?.isStop) break;
          if (chunks.length >= 120) break;
        }
        return chunks;
      }, [effectiveStart, mrna, difficulty]);

      const toggle = (i) => setChecked(prev => { const next = new Set(prev); if (next.has(i)) next.delete(i); else next.add(i); return next; });

      return (
        <section className="p-4 rounded-2xl bg-white border shadow-sm">
          <div className="flex items-center justify-between mb-2">
            <h3 className="font-medium">Codon tracker</h3>
            <div className="flex gap-2 items-center text-xs text-slate-600">
              {difficulty==='Advanced' && (
                <>
                  <span>Start: {manualStart==null? 'click a base in the mRNA to set' : manualStart}</span>
                  {manualStart!=null && <button className="px-2 py-1 rounded-lg border bg-white hover:bg-slate-50" onClick={()=>{onResetManualStart(); setChecked(new Set());}}>Clear start</button>}
                </>
              )}
            </div>
          </div>
          <p className="text-xs text-slate-600 mb-2">
            {difficulty==='Beginner' ? 'Tracking from the highlighted AUG.' : (effectiveStart==null ? 'Click any base in the mRNA above to set your starting position, then tick codons as you go.' : 'Tracker uses your chosen starting base. Click codons to tick them off.')} 
          </p>
          <div className="flex flex-wrap gap-1">
            {codonChunks.map(({i,c,partial},idx)=> {
              const ticked = checked.has(i);
              return (
                <button
                  key={i}
                  onClick={() => toggle(i)}
                  className={`relative px-2 py-1 rounded-md border ${partial ? 'border-dashed' : ''} border-slate-300 text-sm font-mono transition-colors ${ticked ? 'bg-slate-200 line-through opacity-60' : 'bg-white hover:bg-slate-50'}`}
                  title={`Codon ${idx+1} @ ${i}`}
                >
                  {c}
                  {ticked && <span aria-hidden className="absolute -right-2 -top-2 text-emerald-600 text-xs">✓</span>}
                </button>
              );
            })}
          </div>
          {effectiveStart==null && (
            <div className="text-xs text-slate-500 mt-2">Tip: in Advanced mode you must set a start by clicking a base in the mRNA above.</div>
          )}
        </section>
      );
    }

    // ---------- Main app ----------
    function App(){
      const [difficulty,setDifficulty]=useState("Beginner");
      const [lengthAA,setLengthAA]=useState(6);
      const [mrna,setMrna]=useState("");
      const [utr5Len,setUtr5Len]=useState(0);
      const [startIndex,setStartIndex]=useState(0);
      const [rawInput,setRawInput]=useState("");
      const [aaMode,setAaMode]=useState('1'); // '1' or '3'
      const [userAA,setUserAA]=useState(""); // internal 1-letter
      const [submitted,setSubmitted]=useState(false);
      const [showAnswer,setShowAnswer]=useState(false);
      const [showCodonHelp,setShowCodonHelp]=useState(false);
      const [dockCodon,setDockCodon]=useState(false);
      const [showFeedback,setShowFeedback]=useState(false);
      const [showTutorial,setShowTutorial]=useState(false);
      const [showNextTip,setShowNextTip]=useState(false);
      const [firstSubmitSeen,setFirstSubmitSeen]=useState(false);
      const [submitCount,setSubmitCount]=useState(0);
      const [manualStart,setManualStart]=useState(null);

      const newRound=()=>{
        const b=buildmRNA({peptideLength:lengthAA});
        setMrna(b.mrna); setUtr5Len(b.utr5Len); setStartIndex(b.utr5Len);
        setRawInput(""); setUserAA(""); setSubmitted(false); setShowAnswer(false);
        setManualStart(null);
      };

      useEffect(()=>{newRound()},[]);
      useEffect(()=>{newRound()},[difficulty,lengthAA]);
      useEffect(()=>{ try{const o=localStorage.getItem(TUTORIAL_OPT_OUT_KEY)==="1"; if(!o) setShowTutorial(true);}catch{} },[]);

      const translation=useMemo(()=>translateFrom(mrna,startIndex),[mrna,startIndex]);
      const expected=translation.aas;

      // Parse input
      const parseThreeLetter = (text) => {
        const tokens = text.toUpperCase().match(/([A-Z]{3})/g) || [];
        const letters = tokens.map(t=>AA3_TO_1[t]||"").filter(Boolean).join("");
        return letters;
      };

      const handleAAInput = (text) => {
        setRawInput(text);
        let letters = "";
        if (aaMode === '1') {
          letters = text.toUpperCase().replace(/[^ARNDCEQGHILKMFPSTWYV]/g,"");
        } else {
          letters = parseThreeLetter(text);
        }
        setUserAA(letters.slice(0, expected.length));
        setSubmitted(false);
      };

      const scorePct=useMemo(()=>{let c=0;for(let i=0;i<expected.length;i++){ if((userAA[i]||"").toUpperCase()===expected[i]) c++; } return expected.length?Math.round(c/expected.length*100):0;},[expected,userAA]);

      const renderMrna=useMemo(()=>{
        const out=[];let i=0;while(i<mrna.length){
          const isStartHere = i===utr5Len && mrna.slice(i,i+3)==="AUG";
          const selected = (difficulty==='Advanced' && manualStart===i);
          const spanProps = { 'data-i': i, key: `b${i}`, className: `font-mono text-sm md:text-base px-[2px] cursor-pointer ${selected? 'bg-amber-100 rounded-sm underline' : ''}` };
          if(difficulty==="Beginner" && isStartHere){ out.push(<span key={"aug"+i} className="inline-flex items-center justify-center font-mono text-sm md:text-base px-1.5 py-0.5 mx-[1px] rounded-md border bg-emerald-50 border-emerald-300" title="Start codon (AUG)">AUG</span>); i+=3; continue; }
          out.push(<span {...spanProps}>{mrna[i]}</span>); i++; }
        return out;
      },[mrna,utr5Len,difficulty,manualStart]);

      const handleSubmit=()=> {
        setSubmitted(true);
        if(!firstSubmitSeen){ setShowNextTip(true); setFirstSubmitSeen(true);} 
        setSubmitCount((c)=>{ const next=c+1; if(next===2) setShowFeedback(true); return next; });
      };

      const handleMutationFirstCorrect = () => setShowFeedback(true);

      return (
        <div className="min-h-screen w-full bg-slate-50 text-slate-800 p-6">
          <div className="max-w-5xl mx-auto space-y-6">
            <header className="flex items-start justify-between">
              <div>
                <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Genetic Code Translator</h1>
                <p className="text-slate-600 mt-1">Translate the mRNA (5′→3′) into a polypeptide. Type one‑letter <span className="hidden sm:inline">or switch to 3‑letter</span> amino‑acid codes (no stop). Start codon is AUG.</p>
              </div>
              <div className="flex gap-2 items-center">
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>navigator.clipboard?.writeText(mrna)}>Copy mRNA</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowCodonHelp(true)}>Codon helper</button>
                <button className={`px-3 py-2 rounded-xl border shadow-sm ${dockCodon?'bg-slate-900 text-white border-slate-900':'bg-white hover:bg-slate-50'}`} onClick={()=>setDockCodon(s=>!s)}>{dockCodon? 'Hide codon chart' : 'Dock codon chart'}</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowTutorial(true)}>Help</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowFeedback(true)}>Leave feedback</button>
              </div>
            </header>

            <section className="grid md:grid-cols-3 gap-4">
              <div className="p-4 rounded-2xl bg-white border shadow-sm">
                <h2 className="font-medium mb-3">Difficulty</h2>
                <div className="flex gap-2">
                  {["Beginner","Advanced"].map(d=>(
                    <button key={d} onClick={()=>setDifficulty(d)} className={["px-3 py-1.5 rounded-xl border text-sm", difficulty===d?"bg-slate-900 text-white border-slate-900":"bg-white hover:bg-slate-50"].join(" ")}>{d}</button>
                  ))}
                </div>
                <p className="text-xs text-slate-500 mt-2">Beginner: start codon highlighted with frame. Advanced: no hints.</p>
              </div>
              <div className="p-4 rounded-2xl bg-white border shadow-sm">
                <h2 className="font-medium mb-3">Peptide length</h2>
                <input type="range" min={3} max={12} value={lengthAA} onChange={e=>setLengthAA(parseInt(e.target.value))} className="w-full" />
                <div className="text-sm mt-1">{lengthAA} amino acids (includes start M; excludes stop)</div>
              </div>
              <div className="p-4 rounded-2xl bg-white border shadow-sm">
                <h2 className="font-medium mb-3">Actions</h2>
                <div className="flex gap-2 flex-wrap">
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={newRound}>New sequence</button>
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowCodonHelp(true)}>Codon helper</button>
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowTutorial(true)}>Help</button>
                </div>
              </div>
            </section>

            <section className="p-4 rounded-2xl bg-white border shadow-sm">
              <div className="flex items-center justify-between mb-2">
                <h2 className="font-medium">mRNA (5′ → 3′)</h2>
                <div className="text-xs text-slate-500">{difficulty==="Beginner"?"Start codon highlighted.":"No hints shown."}</div>
              </div>
              <div className="flex items-center gap-3 mb-2">
                <div className="text-sm">AA input:</div>
                <div className="inline-flex rounded-xl border overflow-hidden">
                  <button className={`px-3 py-1.5 text-sm ${aaMode==='1'?'bg-slate-900 text-white':'bg-white'}`} onClick={()=>{setAaMode('1'); setRawInput(userAA);}}>1‑letter</button>
                  <button className={`px-3 py-1.5 text-sm ${aaMode==='3'?'bg-slate-900 text-white':'bg-white'}`} onClick={()=>{setAaMode('3'); setRawInput(userAA.split('').map(x=>AA1_TO_3[x]||'').filter(Boolean).join(' '));}}>3‑letter</button>
                </div>
                <div className="ml-auto text-xs text-slate-500">Advanced: click any base in the mRNA to set a start for the tracker.</div>
              </div>
              <div className="flex flex-wrap items-center leading-7" onClick={(e)=>{ if(difficulty!=='Advanced') return; const el = e.target.closest('[data-i]'); if(!el) return; const idx = Number(el.getAttribute('data-i')); if(Number.isFinite(idx)) setManualStart(idx); }}>
                {renderMrna}
              </div>
            </section>

            {/* Codon tracker UI (always on) */}
            <CodonTracker mrna={mrna} startIndex={startIndex} difficulty={difficulty} manualStart={manualStart} onResetManualStart={()=>setManualStart(null)} />

            <section className="p-4 rounded-2xl bg-white border shadow-sm space-y-4">
              <div className="flex items-center gap-3 flex-wrap">
                <label className="text-sm font-medium">Your protein ({aaMode==='1'?'1‑letter':'3‑letter'}):</label>
                <input value={rawInput} onChange={e=>handleAAInput(e.target.value)} placeholder={aaMode==='1'?"e.g., MHFST…":"e.g., Met Ala Cys …"} className="flex-1 min-w-[240px] px-3 py-2 rounded-xl border bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500" />
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>{setRawInput(""); setUserAA(""); setSubmitted(false)}}>Clear</button>
                <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={handleSubmit} disabled={userAA.length===0}>Submit</button>
              </div>

              {submitted && (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="col-span-2">
                    <h3 className="font-medium mb-2">Per‑codon feedback</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm border">
                        <thead className="bg-slate-100"><tr><th className="px-2 py-1 border">#</th><th className="px-2 py-1 border">Codon</th><th className="px-2 py-1 border">Your AA</th><th className="px-2 py-1 border">Correct AA</th><th className="px-2 py-1 border">Status</th></tr></thead>
                        <tbody>
                          {translateFrom(mrna,startIndex).codons.map((codon,i)=>{const info=CODON_TABLE[codon];const correctAA=info?.isStop?"*":info?.aa||"?";const u=(userAA[i]||"").toUpperCase();const has=u.length>0;const ok=has&&!info?.isStop&&u===correctAA;return (
                            <tr key={i} className={ok?"bg-emerald-50":has?"bg-rose-50":""}>
                              <td className="px-2 py-1 border text-center">{i+1}</td>
                              <td className="px-2 py-1 border font-mono text-center">{has?codon:""}</td>
                              <td className="px-2 py-1 border text-center" title={AA1_TO_3[u]||""}>{u}</td>
                              <td className="px-2 py-1 border text-center" title={AA1_TO_3[correctAA]||""}>{has?(info?.isStop?"Stop":correctAA):""}</td>
                              <td className="px-2 py-1 border text-center">{has?(info?.isStop?"Stop":ok?"✓":"✗"):""}</td>
                            </tr>
                          )})}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div>
                    <h3 className="font-medium mb-2">Summary</h3>
                    <div className="p-3 rounded-xl border bg-slate-50">
                      <div className="text-3xl font-semibold">{scorePct}%</div>
                      <div className="text-sm text-slate-600 mt-1">accuracy across {expected.length} codons</div>
                    </div>
                    <div className="mt-3 flex gap-2">
                      <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowAnswer(s=>!s)}>{showAnswer?"Hide answer":"Show answer"}</button>
                      <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowFeedback(true)}>Leave feedback</button>
                    </div>
                    {showAnswer && (
                      <div className="mt-3 text-xs text-slate-600"><div><span className="font-medium">Correct translation:</span> {expected}</div><div className="mt-1"><span className="font-medium">Codons:</span> {translateFrom(mrna,startIndex).codons.join("-")}</div></div>
                    )}
                  </div>
                </div>
              )}
            </section>

            {/* Mutation module appears after a submission */}
            {submitted && (
              <MutationModule mrna={mrna} startIndex={startIndex} onFirstCorrect={handleMutationFirstCorrect} />
            )}

          </div>

          {/* Docked on‑page codon chart */}
          <DockedCodonChart show={dockCodon} onClose={()=>setDockCodon(false)} />

          {/* Modal codon helper */}
          {showCodonHelp && (
            <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-40" onClick={()=>setShowCodonHelp(false)}>
              <div className="max-w-4xl w-full bg-white rounded-2xl border shadow-lg p-4" onClick={e=>e.stopPropagation()}>
                <div className="flex items-center justify-between mb-2"><h3 className="font-medium">Codon helper</h3><button className="px-2 py-1 rounded-lg border" onClick={()=>setShowCodonHelp(false)}>Close</button></div>
                <p className="text-sm text-slate-600 mb-3">Click a codon to copy. Stop codons shown as *; AUG = start.</p>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                  {Object.entries(CODON_TABLE).sort((a,b)=>a[0].localeCompare(b[0])).map(([codon,info])=> (
                    <button key={codon} onClick={()=>navigator.clipboard&&navigator.clipboard.writeText(codon)} className={["flex items-center justify-between w-full px-2 py-1 border rounded-xl text-xs", info.isStop?"bg-rose-50 border-rose-200":info.isStart?"bg-emerald-50 border-emerald-200":"bg-white"].join(" ")} title={`${codon} → ${info.isStop?"Stop":info.aa} ${info.name}`}>
                      <span className="font-mono text-sm">{codon}</span><span className="text-[11px]">{info.isStop?"Stop":`${info.aa} – ${info.name}`}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* First-submit next-steps tip */}
          {showNextTip && (
            <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50" onClick={()=>setShowNextTip(false)}>
              <div className="max-w-md w-full bg-white rounded-2xl border shadow-lg p-6" onClick={(e)=>e.stopPropagation()}>
                <h3 className="text-lg font-medium mb-2">What next?</h3>
                <p className="text-sm text-slate-700 mb-3">You can:</p>
                <ul className="list-disc ml-6 text-sm text-slate-700 space-y-1">
                  <li>Keep attempting this sequence if you didn't get it 100% correct (adjust your protein and resubmit),</li>
                  <li>Click <b>New sequence</b> for a different mRNA, or</li>
                  <li>Try the <b>Mutation challenge</b> below to help you understand mutations.</li>
                </ul>
                <div className="mt-4 flex justify-end"><button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowNextTip(false)}>Got it</button></div>
              </div>
            </div>
          )}

          <TutorialModal show={showTutorial} onClose={()=>setShowTutorial(false)} onOptOut={()=>{try{localStorage.setItem(TUTORIAL_OPT_OUT_KEY,"1")}catch{}; setShowTutorial(false)}} />
          <FeedbackModal show={showFeedback} onClose={()=>setShowFeedback(false)} url={QUALTRICS_URL} />
        </div>
      );
    }

    // ---------- Mutation module (uses updated classifier) ----------
    function MutationModule({ mrna, startIndex, onFirstCorrect }){
      const [challenge,setChallenge]=useState(null);
      const [showHelper,setShowHelper]=useState(false);
      const [dnaAnswer,setDnaAnswer]=useState("");
      const [protAnswer,setProtAnswer]=useState("");
      const [checked,setChecked]=useState(false);
      const [notified,setNotified]=useState(false);
      const [showProteins,setShowProteins]=useState(false);

      const generateRandom=()=>{
        const c = mutateRandom(mrna,startIndex);
        if(c) { setChallenge(c); setDnaAnswer(""); setProtAnswer(""); setChecked(false); setShowProteins(false);} else { alert("Couldn’t generate a valid mutation. Try again."); }
      };

      const ok = checked && challenge && dnaAnswer===challenge.dnaType && protAnswer===challenge.proteinType;
      useEffect(()=>{ if(ok && !notified && onFirstCorrect){ setNotified(true); onFirstCorrect(); } }, [ok, notified, onFirstCorrect]);

      const originalAA = useMemo(()=> translateFrom(mrna, startIndex).aas, [mrna, startIndex]);
      const mutatedAA = useMemo(()=> challenge ? translateFrom(challenge.mutMrna, startIndex).aas : "", [challenge, startIndex]);

      const explanation = React.useMemo(()=>{
        if(!challenge) return "";
        const { dnaType, proteinType, k, pos } = challenge;
        if (proteinType === "Lost start codon") return "The first AUG start codon was disrupted — translation would be unable to initiate correctly.";
        if(dnaType==="Point mutation (SNP)"){
          if(proteinType==="Silent") return "Single‑nucleotide change that did not alter the amino acid.";
          if(proteinType==="Missense") return "Single‑nucleotide change altered a codon, changing one amino acid.";
          if(proteinType==="Nonsense") return "Single‑nucleotide change created a premature stop codon, truncating the protein.";
        } else {
          const boundaryNote = isBoundary(pos, startIndex) ? "at a codon boundary" : "mid‑codon (not at a codon boundary)";
          if(proteinType==="Frameshift") return `${dnaType}: ${k} base(s) changed ${boundaryNote} — the reading frame is disrupted.`;
          if(proteinType==="Unknown impact") return `${dnaType}: ${k} base(s) changed at a codon boundary (multiple of 3) — frame preserved; residues added/removed.`;
        }
        return "";
      },[challenge, startIndex]);

      return (
        <section className="p-4 rounded-2xl bg-white border shadow-sm space-y-3">
          <div className="flex items-center justify-between">
            <h3 className="font-medium">Mutation challenge</h3>
            <div className="flex gap-2">
              <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={generateRandom}>Generate mutated mRNA</button>
              <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowHelper(true)}>Mutation helper</button>
            </div>
          </div>

          {challenge && (
            <div className="space-y-2">
              <div>
                <div className="text-xs text-slate-500 mb-1">Original mRNA</div>
                <div className="leading-7 flex flex-wrap">{mrna.split("").map((c,i)=>(<span key={i} className="font-mono px-[1px]">{c}</span>))}</div>
              </div>
              <div>
                <div className="text-xs text-slate-500 mb-1">Mutated mRNA (differences highlighted)</div>
                <div className="leading-7 flex flex-wrap">{diffSpans(mrna, challenge.mutMrna)}</div>
              </div>

              <div className="p-3 rounded-xl border bg-slate-50">
                <div className="flex flex-wrap gap-2 items-center">
                  <select className="border rounded-xl px-2 py-1" value={dnaAnswer} onChange={e=>{setDnaAnswer(e.target.value); setChecked(false);}}>
                    <option value="">Select DNA mutation…</option>
                    {DNA_TYPES.map(x=> <option key={x} value={x}>{x}</option>)}
                  </select>
                  <select className="border rounded-xl px-2 py-1" value={protAnswer} onChange={e=>{setProtAnswer(e.target.value); setChecked(false);}}>
                    <option value="">Select protein mutation…</option>
                    {PROTEIN_TYPES.map(x=> <option key={x} value={x}>{x}</option>)}
                  </select>
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setChecked(true)} disabled={!dnaAnswer||!protAnswer}>Check</button>
                  <button className="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 shadow-sm" onClick={()=>setShowProteins(s=>!s)}>{showProteins?"Hide translated proteins":"Show translated proteins"}</button>
                </div>

                {checked && (
                  <div className="mt-2 text-sm text-slate-800">
                    <div>DNA: <span className="font-medium">{dnaAnswer||"—"}</span> → {dnaAnswer===(challenge?.dnaType) ? <span className="text-emerald-700">✓ Correct</span> : <span className="text-rose-700">✗ Correct is {challenge?.dnaType}</span>}</div>
                    <div className="mt-1">Protein: <span className="font-medium">{protAnswer||"—"}</span> → {protAnswer===(challenge?.proteinType) ? <span className="text-emerald-700">✓ Correct</span> : <span className="text-rose-700">✗ Correct is {challenge?.proteinType}</span>}</div>
                    {explanation && <div className="mt-2 text-slate-700 text-xs">{explanation}</div>}
                    <div className={"mt-2 "+(dnaAnswer===challenge?.dnaType && protAnswer===challenge?.proteinType?"text-emerald-700":"text-rose-700")}>{dnaAnswer===challenge?.dnaType && protAnswer===challenge?.proteinType?"Correct!":"Not quite — use the Mutation helper and try again."}</div>
                  </div>
                )}

                {showProteins && (
                  <div className="mt-2 text-xs text-slate-700">
                    <div><span className="font-medium">Original protein:</span> {originalAA}</div>
                    <div className="mt-1"><span className="font-medium">Mutated protein:</span> {mutatedAA}</div>
                    <div className="mt-1 text-slate-600">{(mutatedAA.length===originalAA.length?"Frame preserved (possible ×3-base change).":"Frameshift likely (length changed).")}</div>
                  </div>
                )}
              </div>
            </div>
          )}

          <MutationHelperModal show={showHelper} onClose={()=>setShowHelper(false)} />
        </section>
      );
    }

    // Render app (React 17)
    ReactDOM.render(<App/>, document.getElementById('root'));

    // --------- Minimal smoke tests (console) ---------
    (function runTests(){
      try{
        const testMrna = "AAA" + "AUG" + "GCU" + "GCU" + "UAA" + "AAA"; // utr5Len=3
        const startIdx = 3; // valid AUG position

        const before = translateFrom(testMrna,startIdx).aas;
        console.assert(before.startsWith("MA"), "Baseline translation starts with M...");

        // ×3 insertion at codon boundary → Unknown impact
        const arr1 = testMrna.split("");
        arr1.splice(startIdx+3,0,"A","A","A");
        const after1 = translateFrom(arr1.join(""),startIdx).aas;
        const t1 = classifyProteinEffect({op:"Insertion",k:3,oldAA:before,newAA:after1,pos:startIdx+3,startIndex:startIdx,mutMrna:arr1.join("")});
        console.assert(t1 === "Unknown impact","×3 boundary indel → Unknown impact");

        // 1-base deletion mid‑codon → Frameshift
        const arr2 = testMrna.split("");
        arr2.splice(startIdx+4,1);
        const after2 = translateFrom(arr2.join(""),startIdx).aas;
        const t2 = classifyProteinEffect({op:"Deletion",k:1,oldAA:before,newAA:after2,pos:startIdx+4,startIndex:startIdx,mutMrna:arr2.join("")});
        console.assert(t2 === "Frameshift","1-base indel → Frameshift");

        // Point mutation at AUG → Lost start codon
        const arr3 = testMrna.split("");
        arr3[startIdx] = arr3[startIdx] === "A" ? "C" : "C";
        const mut3 = arr3.join("");
        const after3 = translateFrom(mut3,startIdx).aas;
        const t3 = classifyProteinEffect({op:"Point mutation (SNP)",k:1,oldAA:before,newAA:after3,pos:startIdx,startIndex:startIdx,mutMrna:mut3});
        console.assert(t3 === "Lost start codon","Point mutation at start AUG → Lost start codon");

        // Parser 3-letter → 1-letter
        const parsed = ("Met Ala Cys").toUpperCase().match(/([A-Z]{3})/g).map(t=>AA3_TO_1[t]||"").join("");
        console.assert(parsed === "MAC","3-letter parser converts to MAC");

        // Translation guard near the end (no crash)
        const guard = translateFrom("AUGAA", 4).aas; // partial at end
        console.assert(typeof guard === 'string', 'translateFrom returns string even for near-end start');

        console.log("[Genetic Code Translator] tests passed.");
      }catch(err){
        console.error("[Genetic Code Translator] tests failed:", err);
      }
    })();
  </script>
</body>
</html>
